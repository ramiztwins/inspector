name: Validate Cookies Encryption

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-cookies:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Prepare log file
      run: echo "" > log.md

    - name: Check if cookies are encrypted
      run: |
        cookies=$(jq -r '.targets[].probers[].context.cookies | to_entries[] | "\(.key)=\(.value)"' config.prod.json)
        echo "### Cookies Encryption Validation - Started üîç" > log.md
        all_encrypted=true
        for cookie in $cookies; do
          cookie_key=$(echo $cookie | cut -d '=' -f 1)
          cookie_value=$(echo $cookie | cut -d '=' -f 2)
          if ! echo "$cookie_value" | grep -Eq '^[0-9a-fA-F]{32,}$'; then
            echo "$cookie_key: *" >> log.md
            all_encrypted=false
          fi
        done

        if $all_encrypted; then
          sed -i '1s/.*/### Cookies Encryption Validation - Success ‚úÖ/' log.md
        else
          sed -i '1s/.*/### Cookies Encryption Validation - Failed ‚ùå/' log.md
          exit 1
        fi

    - name: Add validation result as comment
      if: always()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: "### Cookies Encryption Validation Result"
        recreate: true
        path: log.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}