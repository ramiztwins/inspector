name: Validate Cookies Encryption

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  validate-cookies:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Parse and Validate Cookies
      uses: actions/github-script@v6
      with:
        script: |
          const fs = require('fs');
          const config = JSON.parse(fs.readFileSync('config.prod.json', 'utf8'));

          let failedCookies = [];
          config.targets.forEach(target => {
            target.probers.forEach(prober => {
              for (const [key, value] of Object.entries(prober.context.cookies)) {
                if (!/^[0-9a-fA-F]{32,}$/.test(value)) {
                  failedCookies.push(`- \`${key}\`: ***`);
                  console.log(`${key}: ***`);
                }
              }
            });
          });

          let logContent = '';
          if (failedCookies.length > 0) {
            logContent = '### Cookies Encryption Validation result - Failed ❌\n\n';
            logContent += failedCookies.join('\n');
            core.setFailed('Cookies Encryption Validation result - Failed ❌');
          } else {
            logContent = '### Cookies Encryption Validation result - Success ✅';
            console.log('Cookies Encryption Validation result - Success ✅');
          }

          fs.writeFileSync('log.md', logContent);

    - name: Add validation result as comment
      if: always()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        header: "### Cookies Encryption Validation Result"
        recreate: true
        path: log.md
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}