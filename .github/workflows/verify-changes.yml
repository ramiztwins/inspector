name: Verify Changes

on:
  pull_request:
    branches:
      - main

permissions:
  pull-requests: write
  contents: read

jobs:
  verify-changes:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: Prepare validation output file
      run: echo "" > verify_changes_output.txt

    - name: Verify changes
      id: check_changes
      run: |
        echo "üîç Checking modified files against main branch..."
        git diff --name-only origin/main > modified_files.txt
        cat modified_files.txt | tee -a verify_changes_output.txt
        
        if grep -qv '^config.prod.json$' modified_files.txt; then
          echo "  ‚ùå Changes detected outside config.prod.json!" | tee -a verify_changes_output.txt
          echo "‚ùå Verification failed: Changes outside config.prod.json detected." | tee -a verify_changes_output.txt
          exit 1
        else
          echo "  ‚úÖ Only config.prod.json was modified." | tee -a verify_changes_output.txt
          echo "‚úÖ Verification successful: Only config.prod.json was modified." | tee -a verify_changes_output.txt
        fi

    - name: Add verification result as comment
      if: always()
      uses: marocchino/sticky-pull-request-comment@v2
      with:
        path: verify_changes_output.txt
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}