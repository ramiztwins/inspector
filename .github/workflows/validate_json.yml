name: Validate JSON

on:
  push:
    paths:
      - '*.json'
  pull_request:
    paths:
      - '*.json'

jobs:
  validate-json:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Go
      uses: actions/setup-go@v4
      with:
        go-version: '1.20'

    - name: Build and run Go code to generate schema.json
      run: |
        go run schema/schema.go
        echo "✅ JSON schema generated"

    - name: Display generated schema.json
      run: |
        echo "📂 Opening schema.json..."
        cat schema.json

    - name: Install Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '16'

    - name: Install AJV
      run: npm install ajv@8 ajv-cli@4

    - name: Validate JSON files
      run: |
        SCHEMA_PATH=$(pwd)/schema.json
        echo "Using schema file: $SCHEMA_PATH"
        shopt -s nullglob
        for file in *.json; do
          [ "$file" = "schema.json" ] && continue
          echo "🔍 Validating $file..."
          if jq empty "$file" > /dev/null 2>&1; then
            npx ajv validate -s "$SCHEMA_PATH" -d "$file" --strict=false > validation_output.json 2>&1
            if [ $? -ne 0 ]; then
              echo "❌ Validation failed for $file"
              cat validation_output.json
              exit 1
            else
              echo "✅ $file is valid"
            fi
          else
            echo "🚫 Syntax Error in $file"
            exit 1
          fi
        done

    - name: Clean up validation output
      run: rm validation_output.json
